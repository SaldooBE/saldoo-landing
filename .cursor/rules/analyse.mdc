---
alwaysApply: false
---
# ğŸ“˜ Saldoo Mini â€“ Backend Logica voor AI Analyse

Deze uitleg vertelt Cursor stap voor stap **hoe de backend van de upload- en analyseflow moet werken**.  
De UI en alle vragen zijn al klaar, te vinden op de /upload pagina. Cursor moet nu enkel zorgen dat alle antwoorden, geÃ¼ploade bestanden en resultaten **juist opgeslagen en verwerkt worden** in Supabase, en dat de **AI-agent** nadien het rapport kan genereren en teruggeven aan de ondernemer.

---

## ğŸ”§ Hoofddoel

Wanneer een ondernemer zijn contextvragen heeft ingevuld en zijn documenten (jaarrekening, balans of fiscale aangifte) heeft opgeladen, moet Cursor:

1. Alle antwoorden **opslaan in Supabase**.  
2. De geÃ¼ploade bestanden **bewaren in Supabase Storage** met de juiste structuur.  
3. Zodra alles binnen is, **de analyse uitvoeren via een vaste pipeline**:  
   - Cijfers uit de bestanden halen (parseren)  
   - Belangrijke KPIâ€™s berekenen  
   - De context en cijfers doorgeven aan de AI  
   - Het uiteindelijke rapport ontvangen en opslaan  
4. Dat rapport opslaan zodat het nadien **getoond kan worden op de analysepagina** aan de ondernemer.

---

## ğŸ§± Datamodel in Supabase

Alles draait rond Ã©Ã©n tabel: **`reports`**.  
Elke keer een ondernemer een analyse start, wordt er Ã©Ã©n â€œreportâ€ aangemaakt.  
Dat rapport bevat niet alleen de antwoorden van de ondernemer, maar ook de resultaten van de AI.

### Belangrijke kolommen in de tabel `reports`
- `id` â†’ Unieke ID van het rapport   
- `client_id` â†’ ID van de ondernemer  
- `context_json` â†’ Alle antwoorden op de vragenlijst (in JSON)  
- `files_json` â†’ Lijst met metadata van geÃ¼ploade bestanden (naam, pad, grootte, type)  
- `normalized_json` â†’ De gestructureerde cijfers die uit de bestanden gehaald werden  
- `kpis_json` â†’ Berekening van de kernratioâ€™s  
- `report_json` â†’ Het eindrapport dat de AI teruggeeft  
- `status` â†’ Huidige status van het rapport  

De **status** van een rapport verandert in verschillende fases:  draft â†’ context_completed â†’ uploaded â†’ parsed â†’ generated

Zo weet het systeem altijd waar de analyse zich bevindt.

De bestanden zelf komen in Supabase Storage, bijvoorbeeld in een mapstructuur zoals: reports/{tenantId}/{clientId}/{reportId}/bestand.pdf


---

## âš™ï¸ Werking in fases

### 1. Ondernemer vult vragen in
Wanneer de ondernemer zijn contextvragen invult in de /upload pagina, hoeft er **geen UI-wijziging** meer te gebeuren. Cursor moet er enkel voor zorgen dat:

- Alle antwoorden automatisch worden **bewaard in Supabase**.  
- Dit mag in real-time gebeuren (autosave) of bij het drukken op â€œOpslaanâ€.  
- Alle data wordt opgeslaan in `reports.context_json`.  

Wanneer de ondernemer alle vragen heeft ingevuld, mag Cursor **de status aanpassen naar `context_completed`**.

---

### 2. Ondernemer uploadt documenten
De ondernemer laadt Ã©Ã©n of meerdere bestanden op (PDF of Excel).  
Cursor hoeft hier niets visueel aan te passen, enkel:

- De bestanden uploaden naar Supabase Storage in de juiste map.  
- De metadata (zoals bestandsnaam, grootte en pad) opslaan in `reports.files_json`.  
- Wanneer minstens Ã©Ã©n bestand is opgeladen, zet de status naar `uploaded`.

---

### 3. Analyse starten
Wanneer de ondernemer op â€œAnalyse startenâ€ klikt, begint de eigenlijke logica van Saldoo Mini.

Cursor moet nu automatisch:
1. De geÃ¼ploade bestanden downloaden.
2. De cijfers eruit halen (parseren).
3. KPIâ€™s berekenen.
4. De ingevulde context en cijfers samen doorgeven aan de AI.
5. Het AI-rapport opslaan.

Elke stap wordt hieronder uitgelegd.

---

## ğŸ§® Stap 1 â€” Parseren van cijfers

Cursor maakt een parserfunctie die de geÃ¼ploade bestanden inleest.  
De parser moet de belangrijkste cijfers herkennen uit jaarrekening, balans of resultatenrekening.  

Voorbeelden van wat eruit gehaald wordt:
- **Omzet**  
- **Kosten** (directe en operationele)  
- **Nettowinst**  
- **Cashpositie**  
- **Eigen vermogen**  
- **Schulden (kort & lang)**  

De parser zet dit alles in een eenvoudig JSON-formaat zoals:

```json
{
  "year": 2024,
  "pnl": {
    "revenue": 150000,
    "direct_costs": 45000,
    "opex": 53000,
    "net_profit": 52000
  },
  "balance": {
    "cash": 18000,
    "receivables": 32000,
    "payables": 12000,
    "equity": 44000,
    "total_assets": 110000,
    "current_liabilities": 35000
  }
}
Dat JSON-bestand wordt opgeslagen in Supabase onder reports.normalized_json.
Indien er bepaalde cijfers ontbreken dan zal dit ook aangegeven worden als ontbrekend.

Stap 2 â€” KPIâ€™s berekenen

Vervolgens maakt Cursor een berekening van een paar basisratioâ€™s:

KPI	Betekenis	Formule
Winstmarge	Hoeveel % van de omzet blijft over als winst	nettowinst / omzet
Kostenratio	Hoeveel % van de omzet naar kosten gaat	(omzet â€“ winst) / omzet
Liquiditeit (current ratio)	Kan de zaak haar korte schulden betalen?	vlottende activa / kortlopende schulden
Solvabiliteit	Hoe sterk is de financiÃ«le buffer?	eigen vermogen / totaal activa

De resultaten worden bewaard in reports.kpis_json.

ğŸ§  Stap 3 â€” Context voorbereiden voor de AI

De vragenlijst van de ondernemer is vrij uitgebreid, maar niet alles is nodig voor de AI.
Cursor maakt dus eerst een compacte context, met enkel de belangrijkste elementen.

Voorbeelden:

Rechtsvorm (eenmanszaak of vennootschap)

Activiteit / sector

Gewenst netto inkomen

Aantal werknemers

Verwachte groei of investeringen

Risicoâ€™s of aansprakelijkheden

En heel belangrijk: ook de gewenste outcome van de ondernemer wordt als startpunt van de analyse genomen voor de AI. 

Deze compacte context wordt samen met de KPIâ€™s en cijfers doorgestuurd naar de AI.

ğŸ¤– Stap 4 â€” Rapport genereren via OpenAI

Nu komt de AI-agent in actie.
Cursor stuurt Ã©Ã©n duidelijke prompt naar OpenAI, met drie onderdelen:

De context van de ondernemer (uit context_json)

De financiÃ«le cijfers (uit normalized_json)

De KPIâ€™s (uit kpis_json)

De AI weet dan alles wat nodig is om een rapport te schrijven.
De instructie is om in het Nederlands te schrijven, op een begrijpbare manier voor een ondernemer zonder financiele achtergrond, met alle cijfers cursief (bijvoorbeeld â‚¬52.000 winst of 34% winstmarge).

Het rapport bestaat uit cards of secties met tekst en zal in totaal voor iedere ondernemer 5 paginas lang zijn. Enkele voorbeeld cards / secties zijn:

Kerncijfers

Kostenstructuur

Liquiditeit

Solvabiliteit

Fiscaliteit (enkel als het een eenmanszaak is)

Actiepunten

De AI stuurt zijn antwoord terug als een JSON-object met een duidelijke structuur, bijvoorbeeld:

{
  "intro": "In dit rapport bespreken we de resultaten van 2024...",
  "cards": [
    { "title": "Kerncijfers", "body": ["Uw omzet bedroeg *â‚¬150.000*..."] },
    { "title": "Liquiditeit", "body": ["Uw current ratio is *1,43*..."] }
  ],
  "actions": ["Versterk uw cashbuffer", "Overweeg een BV bij stijgende winst"],
  "disclaimer": "Dit rapport is informatief en geen vervanging van persoonlijk advies."
}


Dat resultaat wordt opgeslagen in reports.report_json en de status wordt op generated gezet.

ğŸ“„ Stap 5 â€” Rapport tonen aan de ondernemer

De analysepagina (UI) hoeft niet meer aangepast te worden, Cursor moet enkel:

De juiste data ophalen uit Supabase (report_json, kpis_json, normalized_json).

De inhoud inlezen en tonen.

Eventueel de KPIâ€™s in een zijbalk tonen.

Er mag ook een knop voorzien zijn om de analyse opnieuw te genereren indien nodig. Alsook moet er uiteraard een downloadknop zijn voor het gegenereerde rapport. 

Wat Cursor concreet moet opleveren

Backendlogica, niet de UI.

Alle contextantwoorden opslaan in context_json.

GeÃ¼ploade bestanden bewaren in files_json + Storage.

Analysepipeline bouwen die:

Bestanden uitleest

Cijfers normaliseert

KPIâ€™s berekent

Context + cijfers naar OpenAI stuurt

Rapport ontvangt en opslaat

Het rapport tonen via de bestaande analysepagina.

Status correct beheren (draft â†’ generated).

Foutafhandeling: als iets mislukt, status = error en een korte foutmelding loggen.

ğŸ”’ Belangrijk

Alles moet veilig blijven: enkel de juiste gebruiker mag zijn eigen rapport opslaan of opvragen.

Cursor mag geen data van andere klanten lezen.

Context en rapport mogen niet overschreven worden tenzij het echt de bedoeling is.

De OpenAI-aanvraag moet idempotent zijn (dus niet meerdere keren uitvoeren voor hetzelfde rapport).